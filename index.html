<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lpv_vql</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
    }
    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1; /* ゲームcanvasの初期z-index */
    }
    #confettiCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2; /* 紙吹雪canvasの初期z-index */
      pointer-events: none; /* マウスイベントを透過 */
    }
    #headerFrame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: auto;
      border: none;
      z-index: 3; /* header iframeのz-index */
    }
    #contentFrame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      border: none;
      z-index: 0; /* コンテンツ iframeの初期z-index */
    }
  </style>
</head>
<body>
  <iframe id="headerFrame" srcdoc="
    <!DOCTYPE html>
    <html lang='ja'>
    <head>
      <meta charset='UTF-8'>
      <style>
        body {
          margin: 0;
          font-family: sans-serif;
          background-color: transparent;
          color: #fff;
        }
        header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1rem 3rem;
          background-color: #000;
          z-index: 4; /* header自体のz-indexも念のため高く設定 */
        }
        .icon {
          height: 60px;
          border-radius: 50%;
          transition: transform 0.3s ease;
        }
        .icon:hover {
          transform: rotate(10deg) scale(1.05);
        }
        nav a {
          color: white;
          text-decoration: none;
          margin-left: 1rem;
          font-weight: bold;
          transition: color 0.3s;
        }
        nav a:hover {
          color: #0af;
        }
      </style>
    </head>
    <body>
      <header>
        <img id='userIcon' src='https://u.cubeupload.com/gazoulpv_vql/icon13.png' alt='icon' class='icon'>
        <nav>
          <a href='https://lpv-vql.github.io/lpv_vql-profile/' target='_top'>ホーム</a>
          <a href='https://lpv-vql.github.io/lpv_vql-tool/' target='_top'>ツール</a>
          <a href='#' target='_top'>作品一覧</a>
        </nav>
      </header>
    </body>
    </html>
  "></iframe>

  <iframe id="contentFrame" srcdoc="
    <!DOCTYPE html>
    <html lang='ja'>
    <head>
      <meta charset='UTF-8'>
      <style>
        body {
          margin: 0;
          font-family: sans-serif;
          background-color: #111;
          color: #fff;
        }
        main {
          padding: 2rem;
          display: block;
        }
        section {
          width: 60%;
          text-align: left;
          margin: 0 auto 2rem auto;
          animation: fadeIn 1s ease;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .accounts a {
          color: white;
          text-decoration: none;
          display: block;
          transition: color 0.3s;
        }
        .accounts a:hover {
          color: #0af;
        }
        p {
          line-height: 1;
          white-space: pre-line;
        }
      </style>
    </head>
    <body>
      <main>
        <section>
          <h1>lpv_vql</h1>
          <p>
            中2です。ゲームを作ったり、ロボットを作ったり、絵をかいたりしています。<br>
            3DCAD(Autodesk Fusion)による設計が少しできます。<br>
            3Dが大好きです。魚派です。あとおでんが好きです。<br>
            scratch大好き!
          </p>
        </section>
        <section>
          <h2>さわったことある言語</h2>
          <ul>
            <li>Python (scratchattachとか)</li>
            <li>C# (Unity)</li>
            <li>C++ (Arduino)</li>
            <li>HTML/CSS</li>
          </ul>
        </section>
        <section>
          <h2>アカウント</h2>
          <div class='accounts'>
            <a href='https://scratch.mit.edu/users/lpv_vql/' target='_blank'>Scratch: @lpv_vql</a>
            <a href='https://scratch.mit.edu/users/Ougonhi_Hakuginhi/' target='_blank'>Scratch: @Ougonhi_Hakuginhi</a>
            <a href='https://scratch.mit.edu/users/sub_pv/' target='_blank'>Scratch: @sub_pv</a>
            <a href='https://github.com/lpv-vql' target='_blank'>GitHub: @lpv-vql</a>
            <a href='https://www.youtube.com/@lpv_vql' target='_blank'>YouTube: @lpv_vql</a>
          </div>
        </section>
      </main>
    </body>
    </html>
  "></iframe>

  <canvas id="gameCanvas"></canvas>
  <canvas id="confettiCanvas"></canvas>

  <script>
const gameCanvas = document.getElementById("gameCanvas");
  const gameCtx = gameCanvas.getContext("2d");
  const confettiCanvas = document.getElementById("confettiCanvas");
  const confettiCtx = confettiCanvas.getContext("2d");
  const headerFrame = document.getElementById('headerFrame');
  const contentFrame = document.getElementById('contentFrame');

  gameCanvas.width = window.innerWidth;
  gameCanvas.height = window.innerHeight;
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;

  const paddle = {
    width: 150,
    height: 15,
    x: gameCanvas.width / 2 - 100,
    y: gameCanvas.height - 30,
    dx: 20
  };

  const ball = {
    x: gameCanvas.width / 2,
    y: gameCanvas.height - 45,
    radius: 8,
    dx: 4,
    dy: -4
  };

  const brick = {
    rowCount: 8,
    columnCount: 7,
    width: gameCanvas.width / 8,
    height: 65,
    padding: 6,
    offsetTop: 92,
    offsetLeft: 4
  };

  let bricks = [];
  for (let c = 0; c < brick.columnCount; c++) {
    bricks[c] = [];
    for (let r = 0; r < brick.rowCount; r++) {
      bricks[c][r] = { x: 0, y: 0, visible: true };
    }
  }

  let explosions = [];
  let bricksLeft = brick.rowCount * brick.columnCount;
  let confettiParticles = [];
  const confettiCount = 400; // さらに数を増やす
  let confettiPlaying = false;
  let confettiEnded = false; // 紙吹雪が終了したかを追跡するフラグ

  function createConfetti() {
    confettiParticles = [];
    for (let i = 0; i < confettiCount; i++) {
      confettiParticles.push({
        x: Math.random() * confettiCanvas.width,
        y: Math.random() * confettiCanvas.height,
        radius: Math.random() * 6 + 2, // 少し大きく
        color: `hsl(${Math.random() * 360}, 70%, 60%)`,
        velocity: {
          x: (Math.random() - 0.5) * 2, // さらにゆっくり横に
          y: Math.random() * 3 + 1 // さらにゆっくり縦に
        },
        alpha: 1,
        decay: Math.random() * 0.005 + 0.001 // さらにゆっくり消える
      });
    }
    confettiPlaying = true;
    confettiEnded = false; // 新しい紙吹雪開始時にリセット
  }

  function drawConfetti() {
    if (bricksLeft === 0 && !confettiPlaying && !confettiEnded) {
      createConfetti();
    }

    if (confettiPlaying) {
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiParticles.forEach((particle, index) => {
        confettiCtx.beginPath();
        confettiCtx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
        confettiCtx.fillStyle = particle.color;
        confettiCtx.globalAlpha = particle.alpha;
        confettiCtx.fill();
        confettiCtx.closePath();

        particle.x += particle.velocity.x;
        particle.y += particle.velocity.y;
        particle.alpha -= particle.decay;
        particle.velocity.y += 0.02; // 重力もさらに弱く

        if (particle.alpha <= 0) {
          confettiParticles.splice(index, 1);
        }
      });
      confettiCtx.globalAlpha = 1;

      if (confettiParticles.length === 0 && confettiPlaying) {
        confettiPlaying = false;
        confettiEnded = true; // 紙吹雪が終了したことを記録
        gameCanvas.style.zIndex = 0;
        contentFrame.style.zIndex = 1;
      }
    }
  }

  function drawPaddle() {
    gameCtx.fillStyle = "#fff";
    gameCtx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
  }

  function drawBall() {
    gameCtx.beginPath();
    gameCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    gameCtx.fillStyle = "#fff";
    gameCtx.fill();
    gameCtx.closePath();
  }

  function drawBricks() {
    for (let c = 0; c < brick.columnCount; c++) {
      for (let r = 0; r < brick.rowCount; r++) {
        if (bricks[c][r].visible) {
          const brickX = c * (brick.width + brick.padding) + brick.offsetLeft;
          const brickY = r * (brick.height + brick.padding) + brick.offsetTop;
          bricks[c][r].x = brickX;
          bricks[c][r].y = brickY;
          gameCtx.fillStyle = "#FFA500";
          gameCtx.fillRect(brickX, brickY, brick.width, brick.height);
        }
      }
    }
  }

  function collisionDetection() {
    for (let c = 0; c < brick.columnCount; c++) {
      for (let r = 0; r < brick.rowCount; r++) {
        const b = bricks[c][r];
        if (b.visible) {
          if (
            ball.x > b.x &&
            ball.x < b.x + brick.width &&
            ball.y > b.y &&
            ball.y < b.y + brick.height
          ) {
            ball.dy = -ball.dy;
            b.visible = false;
            bricksLeft--;
            explosions.push({ x: b.x + brick.width / 2, y: b.y + brick.height / 2, size: 20 });
          }
        }
      }
    }
  }

  function drawExplosions() {
    gameCtx.fillStyle = "yellow";
    for (let i = 0; i < explosions.length; i++) {
      const explosion = explosions[i];
      gameCtx.beginPath();
      gameCtx.arc(explosion.x, explosion.y, explosion.size, 0, Math.PI * 2);
      gameCtx.fill();
      gameCtx.closePath();
      explosion.size -= 1;
    }
    explosions = explosions.filter(explosion => explosion.size > 0);
  }

  function movePaddle() {
    paddle.x = mouseX - paddle.width / 2;
    if (paddle.x < 0) paddle.x = 0;
    if (paddle.x + paddle.width > gameCanvas.width) paddle.x = gameCanvas.width - gameCanvas.width;
  }

  function moveBall() {
    ball.x += ball.dx;
    ball.y += ball.dy;
    if (ball.x + ball.radius > gameCanvas.width || ball.x - ball.radius < 0) ball.dx = -ball.dx;
    if (ball.y - ball.radius < 0) ball.dy = -ball.dy;
    if (ball.y + ball.radius > gameCanvas.height) {
      ball.x = gameCanvas.width / 2;
      ball.y = gameCanvas.height - 45;
      ball.dy = -ball.dy;
    }
  }

  function detectPaddleCollision() {
    if (
      ball.x > paddle.x &&
      ball.x < paddle.x + paddle.width &&
      ball.y + ball.radius > paddle.y
    ) {
      ball.dy = -ball.dy;
    }
  }

  function draw() {
    gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    drawBall();
    drawPaddle();
    drawBricks();
    drawExplosions();
    moveBall();
    movePaddle();
    collisionDetection();
    detectPaddleCollision();
    drawConfetti();
    requestAnimationFrame(draw);
  }

  let mouseX = 0;
  document.addEventListener("mousemove", (e) => {
    mouseX = e.clientX;
  });

  draw();

  // headerFrameの高さをheader要素の高さに合わせる (必要に応じて)
  window.addEventListener('load', () => {
    const headerDoc = headerFrame.contentDocument || headerFrame.contentWindow.document;
    const headerElement = headerDoc.querySelector('header');
    if (headerElement) {
      headerFrame.style.height = headerElement.offsetHeight + 'px';
      contentFrame.style.top = headerElement.offsetHeight + 'px';
      contentFrame.style.height = `calc(100vh - ${headerElement.offsetHeight}px)`;
    }
  });

  window.addEventListener('resize', () => {
    const headerDoc = headerFrame.contentDocument || headerFrame.contentWindow.document;
    const headerElement = headerDoc.querySelector('header');
    if (headerElement) {
      headerFrame.style.height = headerElement.offsetHeight + 'px';
      contentFrame.style.top = headerElement.offsetHeight + 'px';
      contentFrame.style.height = `calc(100vh - ${headerElement.offsetHeight}px)`;
    }
  });
 </script>
</body>
</html>
